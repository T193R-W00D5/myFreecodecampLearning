name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm staging deployment'
        required: true
        default: ''
      run_critical_tests:
        description: 'Run critical E2E tests before deployment'
        required: true
        default: false
        type: boolean
      target_commit:
        description: 'Specific commit SHA to deploy (leave empty for latest)'
        required: false
        default: ''
      target_branch:
        description: 'Branch to deploy from'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop
          - feature/*

jobs:
  # Pre-deployment validation
  pre-deployment-tests:
    if: github.event.inputs.confirm == 'deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific commit or latest
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_commit || github.event.inputs.target_branch || 'main' }}
          
      - name: Display deployment info
        run: |
          echo "ðŸ§ª STAGING DEPLOYMENT INFORMATION" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.target_branch || 'main' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Message:** $(git log --oneline -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install dependencies
        run: npm ci

      - name: Install Jekyll dependencies
        run: |
          bundle config set --local frozen false
          bundle install

      - name: Install Playwright browsers
        if: github.event.inputs.run_critical_tests == 'true'
        run: npx playwright install --with-deps

      - name: Run TypeScript type checking
        run: npx tsc --noEmit

      - name: Run critical E2E tests
        if: github.event.inputs.run_critical_tests == 'true'
        run: npx playwright test --grep "@critical" --reporter=html
        env:
          CI: true

      - name: Upload test results
        if: always() && github.event.inputs.run_critical_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-staging-pre-deployment
          path: playwright-report/
          retention-days: 7

  # Staging deployment
  deploy-staging:
    if: |
      github.event.inputs.confirm == 'deploy' && 
      needs.pre-deployment-tests.result == 'success'
    needs: pre-deployment-tests
    runs-on: ubuntu-latest
    environment: 
      name: staging
      url: https://t193r-w00d5.github.io/myFreecodecampLearning/staging
    steps:
      - name: Checkout specific commit for staging
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_commit || github.event.inputs.target_branch || 'main' }}

      - name: Log staging deployment details
        run: |
          echo "ðŸ§ª STAGING DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Commit being deployed:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit details:** $(git log --oneline -n 1)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Clean any existing build artifacts
        run: |
          rm -rf _site
          rm -rf .sass-cache
          echo "Cleaned existing build artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Build Jekyll site for staging
        run: |
          bundle config set --local frozen false
          bundle install
          
          # Debug Jekyll environment
          echo "Jekyll version: $(bundle exec jekyll --version)" >> $GITHUB_STEP_SUMMARY
          echo "Ruby version: $(ruby --version)" >> $GITHUB_STEP_SUMMARY
          echo "Current directory: $(pwd)" >> $GITHUB_STEP_SUMMARY
          
          # Build with staging baseurl and verbose output
          echo "Starting Jekyll build for staging..." >> $GITHUB_STEP_SUMMARY
          bundle exec jekyll build --baseurl "/myFreecodecampLearning/staging" --verbose
          
          echo "Jekyll staging build completed. Contents of _site:" >> $GITHUB_STEP_SUMMARY
          ls -la _site/ >> $GITHUB_STEP_SUMMARY
          echo "Checking for Liquid syntax in generated files:" >> $GITHUB_STEP_SUMMARY
          grep -n "{{" _site/index.html || echo "âœ… No unprocessed Liquid syntax found" >> $GITHUB_STEP_SUMMARY
          echo "Checking CSS link paths:" >> $GITHUB_STEP_SUMMARY
          grep -n "css" _site/index.html >> $GITHUB_STEP_SUMMARY || echo "No CSS links found" >> $GITHUB_STEP_SUMMARY

      - name: Add .nojekyll file
        run: |
          touch _site/.nojekyll
          echo "âœ… Added .nojekyll file to prevent GitHub Pages Jekyll processing" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to GitHub Pages (staging)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          destination_dir: staging
          enable_jekyll: false
          force_orphan: false  # Don't orphan staging, append to gh-pages
          disable_nojekyll: false  # Ensure .nojekyll file is created

  # Deployment success notification
  deployment-success:
    if: always() && needs.deploy-staging.result == 'success'
    needs: [pre-deployment-tests, deploy-staging]
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸ§ª Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** https://t193r-w00d5.github.io/myFreecodecampLearning/staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please allow 5-10 minutes for GitHub Pages to update." >> $GITHUB_STEP_SUMMARY