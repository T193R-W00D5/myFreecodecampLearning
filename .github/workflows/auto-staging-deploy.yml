name: Auto-Deploy to Staging

# Automatically deploy to staging when changes are pushed to main
on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/**'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests for faster deployment'
        required: true
        type: boolean
        default: false

# Add explicit permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Quick staging deployment with optional testing
  auto-staging-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Display auto-deployment info
        run: |
          echo "ðŸš€ AUTO-STAGING DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Message:** $(git log --oneline -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.head_commit.author.name || github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js (if running tests)
        if: github.event.inputs.skip_tests != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies (if running tests)
        if: github.event.inputs.skip_tests != 'true'
        run: npm ci

      - name: Run quick smoke tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          npx playwright install chromium --with-deps
          npm start &
          sleep 5
          npx playwright test --grep "@smoke" --project=chromium --reporter=line
        continue-on-error: true
        env:
          CI: true

      - name: Deploy to staging
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          destination_dir: staging
          exclude_assets: |
            .github
            node_modules
            tests
            __tests__
            docs/Ai_chats
            *.config.js
            *.config.ts
            tsconfig.json
            package*.json

      - name: Create deployment notification
        run: |
          echo "## âœ… Staging Auto-Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** https://t193r-w00d5.github.io/myFreecodecampLearning/staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**What's New:**" >> $GITHUB_STEP_SUMMARY
          echo "$(git log --oneline -n 3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ§ª Test new features on staging" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ‘¨â€ðŸ’» If testing successful, deploy to production" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ”„ If issues found, use 'Sync Staging with Production' to revert" >> $GITHUB_STEP_SUMMARY

  # Optional: Notify team about staging deployment
  notify-team:
    needs: auto-staging-deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Post deployment notification
        run: |
          echo "Staging deployment notification would go here"
          # Future enhancement: Add Slack/Teams/Email notification
          # Example:
          # curl -X POST $SLACK_WEBHOOK_URL \
          #   -H 'Content-type: application/json' \
          #   --data '{"text":"ðŸš€ New changes deployed to staging: ${{ github.event.head_commit.message }}"}'