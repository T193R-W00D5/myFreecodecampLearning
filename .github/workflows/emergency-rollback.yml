name: Emergency Rollback

# This workflow has is UNTESTED and should be used with caution.
# It allows for an emergency rollback to a specified commit SHA in production.

env:
  # Set to false for fastest emergency rollback (skips Jekyll build and tests)  
  # Set to true for validated rollback with full Jekyll build and critical tests
  ENABLE_JEKYLL_AND_TESTS: true

on:
  workflow_dispatch:
    inputs:
      rollback_to_commit:
        description: 'Commit SHA to rollback to'
        required: true
      reason:
        description: 'Reason for rollback'
        required: true
        default: 'Emergency rollback due to production issue'
      skip_tests:
        description: 'Skip tests for emergency rollback'
        required: true
        type: boolean
        default: false

jobs:
  emergency-rollback:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout rollback commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_to_commit }}

      - name: Verify rollback commit
        run: |
          echo "ðŸš¨ EMERGENCY ROLLBACK INITIATED" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Rolling back to:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit details:** $(git log --oneline -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Initiated by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js from package.json
        uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'

      - name: Setup Ruby from Gemfile
        uses: ruby/setup-ruby@v1

      - name: Install dependencies (if Jekyll/tests enabled)
        if: env.ENABLE_JEKYLL_AND_TESTS == 'true'
        run: npm ci

      - name: Install Jekyll dependencies (if Jekyll enabled)
        if: env.ENABLE_JEKYLL_AND_TESTS == 'true'
        run: |
          bundle config set --local frozen false
          bundle install

      - name: Build Jekyll site for rollback (if Jekyll enabled)
        if: env.ENABLE_JEKYLL_AND_TESTS == 'true'
        run: |
          echo "Building Jekyll site for emergency rollback..." >> $GITHUB_STEP_SUMMARY
          bundle exec jekyll build --baseurl "/myFreecodecampLearning"
          echo "Jekyll rollback build completed" >> $GITHUB_STEP_SUMMARY

      - name: Prepare deployment files
        run: |
          if [ "${{ env.ENABLE_JEKYLL_AND_TESTS }}" == "true" ]; then
            echo "Using Jekyll build output for rollback" >> $GITHUB_STEP_SUMMARY
            # Jekyll build creates _site directory
            ls -la _site/ >> $GITHUB_STEP_SUMMARY
          else
            echo "Using raw files for emergency rollback" >> $GITHUB_STEP_SUMMARY
            # For raw files, create _site directory with current files
            mkdir -p _site
            cp -r * _site/ 2>/dev/null || true
            # Remove unwanted files from _site
            rm -rf _site/.github _site/node_modules _site/tests _site/__tests__ 
            rm -rf _site/docs/Ai_chats _site/vendor _site/*.config.js _site/*.config.ts
            rm -rf _site/tsconfig.json _site/package*.json _site/Gemfile* 
            rm -rf _site/.gitignore _site/README.md
            ls -la _site/ >> $GITHUB_STEP_SUMMARY
          fi

      - name: Add .nojekyll file
        run: |
          touch _site/.nojekyll
          echo "âœ… Added .nojekyll file for rollback deployment" >> $GITHUB_STEP_SUMMARY

      - name: Upload rollback site artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: Deploy rollback to production
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create rollback notification
        run: |
          echo "## âœ… Emergency Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback successful:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Live URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ Action Items:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify rollback is working correctly" >> $GITHUB_STEP_SUMMARY
          echo "2. Investigate root cause of issue" >> $GITHUB_STEP_SUMMARY
          echo "3. Create hotfix for the issue" >> $GITHUB_STEP_SUMMARY
          echo "4. Test hotfix thoroughly before next deployment" >> $GITHUB_STEP_SUMMARY