name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''
      run_critical_tests:
        description: 'Run critical E2E tests before deployment'
        required: true
        default: true
        type: boolean
      target_commit:
        description: 'Specific commit SHA to deploy (leave empty for latest)'
        required: false
        default: ''
      target_branch:
        description: 'Branch to deploy from'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop

jobs:
  # Pre-deployment validation
  pre-deployment-tests:
    if: github.event.inputs.confirm == 'deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific commit or latest
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_commit || github.event.inputs.target_branch || 'main' }}
          
      - name: Display deployment info
        run: |
          echo "ðŸš€ PRODUCTION DEPLOYMENT INFORMATION" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.target_branch || 'main' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Message:** $(git log --oneline -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install dependencies
        run: npm ci

      - name: Install Jekyll dependencies
        run: |
          bundle config set --local frozen false
          bundle install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run TypeScript type checking
        run: npx tsc --noEmit

      - name: Run critical E2E tests
        if: github.event.inputs.run_critical_tests == 'true'
        run: npx playwright test --grep "@critical" --reporter=html
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-production-pre-deployment
          path: playwright-report/
          retention-days: 7

  # Production deployment
  deploy-production:
    if: |
      github.event.inputs.confirm == 'deploy' && 
      needs.pre-deployment-tests.result == 'success'
    needs: pre-deployment-tests
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://t193r-w00d5.github.io/myFreecodecampLearning
    steps:
      - name: Checkout specific commit for production
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_commit || github.event.inputs.target_branch || 'main' }}

      - name: Log production deployment details
        run: |
          echo "ðŸ“¦ PRODUCTION DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Commit being deployed:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit details:** $(git log --oneline -n 1)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Clean any existing build artifacts
        run: |
          rm -rf _site
          rm -rf .sass-cache
          echo "Cleaned existing build artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Build Jekyll site for production
        run: |
          bundle config set --local frozen false
          bundle install
          
          # Debug Jekyll environment
          echo "Jekyll version: $(bundle exec jekyll --version)" >> $GITHUB_STEP_SUMMARY
          echo "Ruby version: $(ruby --version)" >> $GITHUB_STEP_SUMMARY
          echo "Bundler version: $(bundle --version)" >> $GITHUB_STEP_SUMMARY
          echo "Current directory: $(pwd)" >> $GITHUB_STEP_SUMMARY
          echo "Config file exists: $(test -f _config.yml && echo 'YES' || echo 'NO')" >> $GITHUB_STEP_SUMMARY
          
          # Show config before build
          echo "Jekyll config baseurl before build:" >> $GITHUB_STEP_SUMMARY
          grep "baseurl:" _config.yml >> $GITHUB_STEP_SUMMARY || echo "No baseurl in config" >> $GITHUB_STEP_SUMMARY
          
          # Build with production baseurl and verbose output
          echo "Starting Jekyll build with verbose output..." >> $GITHUB_STEP_SUMMARY
          bundle exec jekyll build --baseurl "/myFreecodecampLearning" --verbose --trace
          
          echo "Jekyll production build completed. Contents of _site:" >> $GITHUB_STEP_SUMMARY
          ls -la _site/ >> $GITHUB_STEP_SUMMARY
          
          echo "Full generated index.html:" >> $GITHUB_STEP_SUMMARY
          cat _site/index.html >> $GITHUB_STEP_SUMMARY
          
          echo "Checking for Liquid syntax in generated files:" >> $GITHUB_STEP_SUMMARY
          grep -n "{{" _site/index.html || echo "âœ… No unprocessed Liquid syntax found" >> $GITHUB_STEP_SUMMARY
          
          echo "Checking navigation links:" >> $GITHUB_STEP_SUMMARY
          grep -n "href.*pages" _site/index.html >> $GITHUB_STEP_SUMMARY || echo "No page links found" >> $GITHUB_STEP_SUMMARY

      - name: Add .nojekyll file
        run: |
          touch _site/.nojekyll
          echo "âœ… Added .nojekyll file to prevent GitHub Pages Jekyll processing" >> $GITHUB_STEP_SUMMARY

      - name: Verify deployment files before upload
        run: |
          echo "ðŸ“‹ DEPLOYMENT VERIFICATION" >> $GITHUB_STEP_SUMMARY
          echo "Files to be deployed:" >> $GITHUB_STEP_SUMMARY
          find _site -type f -name "*.html" | head -10 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Final check of index.html navigation links:" >> $GITHUB_STEP_SUMMARY
          grep -n "href.*Certified.*Full.*Stack" _site/index.html >> $GITHUB_STEP_SUMMARY || echo "No navigation links found" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to GitHub Pages (production)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          enable_jekyll: false
          force_orphan: true

  # Deployment success notification
  deployment-success:
    if: always() && needs.deploy-production.result == 'success'
    needs: [pre-deployment-tests, deploy-production]
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Live URL:** https://t193r-w00d5.github.io/myFreecodecampLearning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please allow 5-10 minutes for GitHub Pages to update." >> $GITHUB_STEP_SUMMARY